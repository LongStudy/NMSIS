TARGET ?= DSP
LIB_PREFIX ?= nmsis
LIBIRAY_ROOT ?= Library
BUILD_ROOT ?= build
TOOLCHAIN ?= GCC
BUILD_TARGET ?= all

# Build Configuration
DSP64 ?= ON
LOOPUNROLL ?= ON
ROUNDING ?= OFF
MATRIXCHECK ?= OFF
RISCV_UNALIGN ?= OFF

DSP_JSON_CONFIG ?= Scripts/Build/nmsis_dsp.json
NN_JSON_CONFIG ?= Scripts/Build/nmsis_dsp.json
NNREF_JSON_CONFIG ?= Scripts/Build/nmsis_ref.json

MAKE_INFO += DSP64=$(DSP64) LOOPUNROLL=$(LOOPUNROLL) \
	ROUNDING=$(ROUNDING) MATRIXCHECK=$(MATRIXCHECK) RISCV_UNALIGN=$(RISCV_UNALIGN)


.PHONY: gen_dsp_lib gen_nn_lib gen

gen_dsp_lib:
	@echo "Generated DSP library for configuration file $(DSP_JSON_CONFIG)"
	./Scripts/Build/nlbuild.py --config $(DSP_JSON_CONFIG) --lib_src DSP/Source --lib_prefix nmsis_dsp \
		--lib_root $(LIBIRAY_ROOT)/DSP/$(TOOLCHAIN) --strip --target $(BUILD_TARGET)

gen_nn_lib:
	@echo "Generated NN library for configuration file $(NN_JSON_CONFIG)"
	./Scripts/Build/nlbuild.py --config $(NN_JSON_CONFIG) --lib_src NN/Source --lib_prefix nmsis_nn \
		--lib_root $(LIBIRAY_ROOT)/NN/$(TOOLCHAIN) --strip --target $(BUILD_TARGET)

gen_nnref_lib:
	@echo "Generated NN Reference library for configuration file $(NNREF_JSON_CONFIG)"
	./Scripts/Build/nlbuild.py --config $(NNREF_JSON_CONFIG) --lib_src NN/NN_Lib_Tests/nn_test \
	--lib_prefix nmsis_nnref --lib_root $(LIBIRAY_ROOT)/NNREF/$(TOOLCHAIN) --strip --target $(BUILD_TARGET)

gen: gen_dsp_lib gen_nn_lib
	@echo "All libraries are generated into $(LIBIRAY_ROOT)"
